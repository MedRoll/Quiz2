<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Interattivo</title>
  <style>
    /* --- STILI BASE --- */
    html { font-size: 16px; scroll-behavior: smooth; }
    body { font-family: 'Segoe UI', sans-serif; background-color: #1c1f2b; color: #fff; padding: 20px; max-width: 900px; margin: auto; }
    h1 { text-align: center; color: #1a73e8; margin-bottom: 30px; }
    .stats { display: flex; justify-content: space-between; margin-bottom: 15px; }
    .card { background-color: #2a2e3d; color: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }

    /* --- RISPOSTE --- */
    .risposta { 
      background-color: #ffffff; 
      color: #000; 
      border: 2px solid #ccc; 
      margin: 10px 0; 
      padding: 15px 20px; 
      border-radius: 8px; 
      font-size: 1.2rem; 
      font-weight: bold; 
      cursor: pointer; 
      transition: all 0.25s ease-in-out; 
      opacity: 0; 
      transform: translateY(10px); 
      animation: fadeInUp 0.6s ease forwards; 
    }
    .risposta:hover { transform: scale(1.03); box-shadow: 0 0 12px rgba(255,255,255,0.3); }
    .corretta { background-color: #28a745; color: white; border-color: #28a745; }
    .sbagliata { background-color: #dc3545; color: white; border-color: #dc3545; }

    /* --- BOTTONI --- */
    button { 
      padding: 10px 16px; 
      margin: 5px; 
      border: none; 
      border-radius: 6px; 
      background-color: #1a73e8; 
      color: white; 
      font-weight: bold; 
      cursor: pointer; 
      transition: all 0.25s ease-in-out;
      opacity: 0; 
      transform: translateY(10px); 
      animation: fadeInUp 0.6s ease forwards; 
    }
    button:hover { background-color: #155ab6; transform: scale(1.07); box-shadow: 0px 0px 15px rgba(26,115,232,0.6); }
    button:active { transform: scale(0.95); box-shadow: 0px 0px 8px rgba(0,0,0,0.3) inset; }
    .btn-danger { background-color: #d93025; }
    .btn-danger:hover { background-color: #b5271b; }

    /* --- RECAP --- */
    #risposte { display: grid; gap: 1rem; }
    .domandaRecap { background-color: #2f3347; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #444; }
    .domandaRecap strong { display: block; margin-bottom: 6px; font-size: 1.1em; color: #1a73e8; }
    .domandaRecap div { margin: 4px 0; }

    /* --- ANIMAZIONI --- */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .progress-bar-animate {
      transition: width 0.4s ease-in-out;
    }
  </style>
  <!-- Chart.js e DataLabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
  <!-- MENU INIZIALE -->
  <div id="start-container" style="text-align: center; margin-bottom: 30px;">
    <h1>Benvenuto!</h1>
    <button onclick="setDocenteMode(false)">üìù Modalit√† Studente</button>
    <button onclick="setDocenteMode(true)">üë©‚Äçüè´ Modalit√† Docente</button>
  </div>

  <!-- SELEZIONE QUIZ -->
 <div id="quiz-buttons" style="margin-top:20px; display:none; text-align:center;">
    <h2 id="quiz-title"></h2>
    <div style="display: grid; gap: 10px; max-width: 600px; margin: auto;">
        <button onclick="iniziaQuiz(1)">üñ•Ô∏è Modulo 1 - Hardware & Anatomia</button>
        <button onclick="iniziaQuiz(2)">üñ±Ô∏è Modulo 2 - Mouse & Tastiera</button>
        <button onclick="iniziaQuizAlternativo(3)">üñ±Ô∏è Modulo 3 - Simulazione Windows (Esercizi Interattivi)</button>
        <button onclick="iniziaQuiz(4)">‚òÅÔ∏è Modulo 4 - Digitale & Sicurezza</button>
        <button onclick="iniziaQuiz(5)" style="opacity: 0.6;">üéì Esame Finale (Opzionale)</button>
    </div>
    <div style="margin-top:25px;">
      <button onclick="tornaAllaModalita()" style="background-color: #6c757d;">‚¨ÖÔ∏è Torna alla scelta modalit√†</button>
    </div>
  </div>

  <!-- QUIZ CLASSICO -->
  <h1 style="display:none;" id="titolo-quiz">Quiz a Scelta Multipla</h1>
  <div class="stats" id="stats-container" style="display:none;">
    <div><strong>Punteggio:</strong> <span id="punteggio">0</span></div>
    <div><strong>Domanda:</strong> <span id="contatore">0</span></div>
  </div>
  <div class="progress-container" id="progress-container" style="display:none; background-color: #444; border-radius: 30px; margin-bottom: 20px; overflow: hidden;">
    <div id="progress-bar" class="progress-bar-animate" style="width: 0%; height: 14px; background: linear-gradient(to right, #ff416c, #ff4b2b);"></div>
  </div>
  <div class="card" id="card-container" style="display:none;">
    <div id="domanda" style="font-size: 1.4em; font-weight: bold; border: 2px solid #007bff; padding: 20px; border-radius: 10px; background-color: #2a2e3d; color: white; margin-bottom: 20px;">Caricamento...</div>
    <div id="risposte"></div>
    <div id="feedback" style="margin-top: 15px;"></div>
  </div>
  <div class="controls" id="controls-container" style="display:none; text-align:center;">
    <button onclick="domandaPrecedente()">‚¨ÖÔ∏è Indietro</button>
    <button onclick="prossimaDomanda()">‚û°Ô∏è Avanti</button>
    <button class="btn-danger" onclick="terminaTest()">üõë Termina Test</button>
    <button onclick="ricomincia()">üîÑ Ricomincia</button>
    <button onclick="tornaAiQuiz()">‚¨ÖÔ∏è Torna al Menu</button>
  </div>
  <div id="recap"></div>

  <!-- MODALIT√Ä DOCENTE -->
  <div id="docente-container" style="display:none;">
    <h1>Modalit√† Docente</h1>
    <div id="lista-docente"></div>
    <div style="text-align:center;">
      <button onclick="tornaAiQuiz()">‚¨ÖÔ∏è Torna al Menu</button>
    </div>
  </div>
  <script>
    let domandeTotali = 0;
    let domandeCorrenti = 0;
    let quizCorrente = 0;
    let risposteCorrette = 0;
    let statoRisposta = []; // Memorizza lo stato delle risposte

    // Nuove variabili per la gestione dei quiz alternativi
    let isQuizAlternativo = false;
    let esercizioCorrente = 0;

    // --- FUNZIONI COMUNI ---

    function updateStats() {
      document.getElementById('progress-text').innerText = `Domanda ${domandeCorrenti + 1} di ${domandeTotali}`;
      document.getElementById('score-text').innerText = `Corrette: ${risposteCorrette}`;
      // Aggiorna la barra di progresso
      const percent = (domandeCorrenti + 1) / domandeTotali * 100;
      document.getElementById('progress-bar').style.width = percent + '%';
    }

    // --- LOGICA QUIZ MULTIPLO STANDARD (Quiz 1, 2, 4, 5) ---

    async function iniziaQuiz(quizId) {
      quizCorrente = quizId;
      isQuizAlternativo = false;
      document.getElementById('quiz-buttons').style.display = 'none';
      document.getElementById('start-container').style.display = 'none';
      document.getElementById('titolo-quiz').innerText = document.querySelector(`button[onclick="iniziaQuiz(${quizId})"]`).innerText;
      document.getElementById('titolo-quiz').style.display = 'block';

      const res = await fetch(`/quiz_all/${quizId}`);
      const domande = await res.json();
      domandeTotali = domande.length;
      domandeCorrenti = 0;
      risposteCorrette = 0;
      statoRisposta = new Array(domandeTotali).fill(null);
      
      document.getElementById('card-container').style.display = 'block';
      document.getElementById('controls-container').style.display = 'block';
      document.getElementById('stats-container').style.display = 'flex';
      document.getElementById('progress-container').style.display = 'block';
      
      caricaDomanda();
    }

    async function caricaDomanda() {
      const res = await fetch(`/quiz/${quizCorrente}/${domandeCorrenti}`);
      const d = await res.json();
      const card = document.getElementById('card-container');
      card.innerHTML = '';
      
      if (d.errore) {
        card.innerHTML = `<div class="card"><h2>Errore: ${d.errore}</h2></div>`;
        return;
      }

      card.innerHTML += `<div class="card">
                          <p class="question-text">${d.domanda}</p>
                          <div id="risposte-container">
                            ${d.risposte.map((r, i) => 
                              `<button class="risposta-btn" onclick="controllaRisposta('${r}', '${d.corretta}', this)">${r}</button>`
                            ).join('')}
                          </div>
                        </div>`;
      
      updateStats();
      const stato = statoRisposta[domandeCorrenti];
      if (stato !== null) {
        disableAnswers(stato.risposta, stato.corretta);
      }
      
      document.getElementById('next-btn').disabled = stato === null;
      document.getElementById('prev-btn').disabled = domandeCorrenti === 0;
    }

    function controllaRisposta(risposta, corretta, button) {
      if (statoRisposta[domandeCorrenti] !== null) return; 

      const isCorretta = risposta === corretta;
      statoRisposta[domandeCorrenti] = { risposta, corretta, isCorretta };

      if (isCorretta) {
        risposteCorrette++;
      }
      
      disableAnswers(risposta, corretta);
      document.getElementById('next-btn').disabled = false;
      updateStats();
      mostraFeedback(isCorretta);
    }

    function disableAnswers(rispostaSelezionata, corretta) {
      document.querySelectorAll('#risposte-container .risposta-btn').forEach(btn => {
        btn.disabled = true;
        if (btn.innerText === corretta) {
          btn.classList.add('corretta');
        } else if (btn.innerText === rispostaSelezionata && rispostaSelezionata !== corretta) {
          btn.classList.add('sbagliata');
        } else {
          btn.classList.add('disattivata');
        }
      });
    }

    function mostraFeedback(isCorretta) {
      const card = document.getElementById('card-container').querySelector('.card');
      card.style.border = isCorretta ? '2px solid #28a745' : '2px solid #dc3545';
      card.innerHTML += `<div style="margin-top: 15px; padding: 10px; border-radius: 5px; background-color: ${isCorretta ? '#28a74533' : '#dc354533'};">
                            ${isCorretta ? '‚úÖ Risposta Esatta!' : '‚ùå Risposta Sbagliata! La risposta corretta √®: ' + statoRisposta[domandeCorrenti].corretta}
                         </div>`;
      setTimeout(() => { card.style.border = ''; }, 2000);
    }

    // --- LOGICA QUIZ ALTERNATIVO (Modulo 3) ---
    
    async function iniziaQuizAlternativo(quizId) {
      quizCorrente = quizId;
      isQuizAlternativo = true;
      document.getElementById('quiz-buttons').style.display = 'none';
      document.getElementById('start-container').style.display = 'none';
      document.getElementById('titolo-quiz').innerText = document.querySelector(`button[onclick="iniziaQuizAlternativo(${quizId})"]`).innerText;
      document.getElementById('titolo-quiz').style.display = 'block';

      const res = await fetch(`/quiz_all_alt/${quizId}`);
      const domande = await res.json();
      domandeTotali = domande.length;
      domandeCorrenti = 0;
      risposteCorrette = 0;
      statoRisposta = new Array(domandeTotali).fill(null);
      
      document.getElementById('card-container').style.display = 'block';
      document.getElementById('controls-container').style.display = 'block';
      document.getElementById('stats-container').style.display = 'flex';
      document.getElementById('progress-container').style.display = 'block';
      
      caricaEsercizio();
    }

    async function caricaEsercizio() {
      if (!isQuizAlternativo) return caricaDomanda();

      const res = await fetch(`/quiz_alt/${quizCorrente}/${domandeCorrenti}`);
      const d = await res.json();
      const card = document.getElementById('card-container');
      card.innerHTML = '';
      
      if (d.errore) {
        card.innerHTML = `<div class="card"><h2>Errore: ${d.errore}</h2></div>`;
        return;
      }

      let esercizioHTML = '';

      switch (d.type) {
        case 'order':
          // Esercizio di Sequenziamento (l'utente clicca nell'ordine corretto)
          esercizioHTML = `
            <div id="order-target" class="list-group mb-3">
                <p><strong>Sequenza scelta:</strong></p>
                <div id="order-sequence" style="min-height: 40px; border: 1px solid #1a73e8; padding: 5px; border-radius: 5px; background: #3c4043;">Nessun passo selezionato.</div>
            </div>
            <p><strong>Clicca i passi nell'ordine corretto:</strong></p>
            <div id="order-options" class="list-group">
                ${d.passi.sort(() => Math.random() - 0.5).map(passo => 
                    `<button class="risposta-btn passo-btn" onclick="aggiungiPasso(this)">${passo}</button>`
                ).join('')}
            </div>
            <button id="controlla-ordine" class="check-btn" onclick="controllaOrdine('${d.corretto.join('|||')}')">Controlla Ordine</button>
          `;
          break;

        case 'match_pair':
          // Esercizio di Associazione
          let optionsRight = [...d.options_right].sort(() => Math.random() - 0.5);
          esercizioHTML = `
            <div style="display: flex; justify-content: space-around; gap: 10px;">
                <div id="match-left" class="list-group" style="flex: 1;">
                    <p><strong>Concetto (Sinistra)</strong></p>
                    ${d.options_left.map((item, i) => `<button class="risposta-btn match-btn-left" data-index="${i}" onclick="selezionaMatch(this, 'left')">${item}</button>`).join('')}
                </div>
                <div id="match-right" class="list-group" style="flex: 1;">
                    <p><strong>Descrizione (Destra)</strong></p>
                    ${optionsRight.map((item, i) => `<button class="risposta-btn match-btn-right" data-value="${item}" onclick="selezionaMatch(this, 'right')">${item}</button>`).join('')}
                </div>
            </div>
            <div id="match-selection" style="margin-top: 20px; text-align: center;">
                <p>Seleziona un elemento a sinistra, poi il corrispondente a destra.</p>
            </div>
            <button id="controlla-match" class="check-btn" onclick="controllaAssociazione('${JSON.stringify(d.corretto_pairs)}')">Controlla Associazione</button>
          `;
          break;
        
        case 'input_text':
          // Esercizio di Input Testuale (Simulazione Comando)
          esercizioHTML = `
            <div style="text-align: center;">
                <p><strong>Cosa digiteresti (parola singola)?</strong></p>
                <input type="text" id="input-command" class="form-control" style="width: 80%; max-width: 300px; padding: 10px; margin: 10px auto; border-radius: 5px; border: none; font-size: 1.1em; text-align: center; color: #000;" placeholder="Digita qui il comando o la parola">
                <p style="font-size: 0.9em; color: #aaa;">Suggerimento: ${d.hint || 'Nessun suggerimento'}</p>
            </div>
            <button id="controlla-input" class="check-btn" onclick="controllaInput('${d.corretta}')">Controlla Input</button>
          `;
          break;

        default:
          esercizioHTML = '<h2>Tipo di esercizio non supportato.</h2>';
          break;
      }
      
      card.innerHTML = `<div class="card">
                          <p class="question-text">${d.domanda}</p>
                          <div id="esercizio-container">${esercizioHTML}</div>
                        </div>`;

      // Ripristina lo stato se gi√† risposto
      if (statoRisposta[domandeCorrenti] !== null) {
          const stato = statoRisposta[domandeCorrenti];
          mostraFeedbackAlternativo(stato.isCorretta, stato.corretta);
          document.getElementById('next-btn').disabled = false;
          // Disabilita i controlli dell'esercizio
          const checkBtn = document.querySelector('.check-btn');
          if(checkBtn) checkBtn.disabled = true;
      } else {
        document.getElementById('next-btn').disabled = true;
      }

      updateStats();
      document.getElementById('prev-btn').disabled = domandeCorrenti === 0;
    }

    // --- LOGICA SPECIFICA ESERCIZIO ORDINE ---
    let passiScelti = [];
    function aggiungiPasso(button) {
        if(statoRisposta[domandeCorrenti] !== null) return;
        passiScelti.push(button.innerText);
        document.getElementById('order-sequence').innerText = passiScelti.join(' ‚Üí ');
        button.disabled = true;
        button.classList.add('sbagliata'); // Uso 'sbagliata' per indicare che √® stato selezionato
    }
    
    function controllaOrdine(correttoStr) {
        const corretta = correttoStr.split('|||');
        const isCorretta = passiScelti.join('|||') === corretta.join('|||');
        
        salvaEsercizioAlternativo(isCorretta, corretta.join(' ‚Üí '), passiScelti.join(' ‚Üí '));
        passiScelti = []; // Reset per la prossima
        
        if (isCorretta) {
            document.querySelectorAll('.passo-btn').forEach(btn => btn.classList.remove('sbagliata'));
            document.getElementById('order-sequence').classList.add('corretta');
        } else {
            document.getElementById('order-sequence').classList.add('sbagliata');
        }
    }

    // --- LOGICA SPECIFICA ESERCIZIO MATCH ---
    let selectedLeft = null;
    let selectedRight = null;
    let matchedPairs = [];

    function selezionaMatch(button, side) {
        if(statoRisposta[domandeCorrenti] !== null) return;

        // Reset visivo di tutti
        document.querySelectorAll('.match-btn-left').forEach(btn => btn.classList.remove('match-active'));
        document.querySelectorAll('.match-btn-right').forEach(btn => btn.classList.remove('match-active'));

        if (side === 'left') {
            selectedLeft = button;
            selectedRight = null;
            button.classList.add('match-active');
        } else if (side === 'right') {
            selectedRight = button;
            selectedRight.classList.add('match-active');
        }

        // Se entrambi selezionati, prova l'accoppiamento
        if (selectedLeft && selectedRight) {
            const pair = [selectedLeft.innerText, selectedRight.innerText];
            const isMatch = matchedPairs.every(p => p[0] !== pair[0] && p[1] !== pair[1]); // Evita duplicati

            if (isMatch) {
                // Rimuovi dai pulsanti e aggiungi come coppia visualizzata
                selectedLeft.style.display = 'none';
                selectedRight.style.display = 'none';
                matchedPairs.push(pair);
                document.getElementById('match-selection').innerHTML += `<div class="risposta corretta match-pair-display" style="padding: 5px; margin: 5px; font-size: 0.9em;">‚úÖ ${pair[0]} ‚ÜîÔ∏è ${pair[1]}</div>`;
            }
            
            // Reset selezione
            selectedLeft = null;
            selectedRight = null;
            document.querySelectorAll('.match-btn-left').forEach(btn => btn.classList.remove('match-active'));
            document.querySelectorAll('.match-btn-right').forEach(btn => btn.classList.remove('match-active'));
        }
    }

    function controllaAssociazione(correttoJson) {
        const corretti = JSON.parse(correttoJson);
        if (matchedPairs.length !== corretti.length) {
            salvaEsercizioAlternativo(false, 'Tutte le coppie devono essere associate');
            return;
        }

        let corretteCount = 0;
        let risposteDate = matchedPairs.map(p => p.join(' = '));

        for (const [left, right] of matchedPairs) {
            const found = corretti.some(([cLeft, cRight]) => cLeft === left && cRight === right);
            if (found) {
                corretteCount++;
            }
        }

        const isCorretta = corretteCount === corretti.length;
        const correttaStr = corretti.map(p => p.join(' = ')).join(' | ');

        salvaEsercizioAlternativo(isCorretta, correttaStr, risposteDate.join(' | '));
    }


    // --- LOGICA SPECIFICA ESERCIZIO INPUT ---

    function controllaInput(corretta) {
        const inputField = document.getElementById('input-command');
        const rispostaUtente = inputField.value.trim();
        const isCorretta = rispostaUtente.toLowerCase() === corretta.toLowerCase();

        salvaEsercizioAlternativo(isCorretta, corretta, rispostaUtente);
        inputField.disabled = true;
    }

    // --- FUNZIONI RISULTATO E SALVATAGGIO ALTERNATIVO ---
    
    function mostraFeedbackAlternativo(isCorretta, corretta) {
      const card = document.getElementById('card-container').querySelector('.card');
      card.style.border = isCorretta ? '2px solid #28a745' : '2px solid #dc3545';
      const testoFeedback = isCorretta ? 
                            '‚úÖ Esercizio completato correttamente!' : 
                            `‚ùå Non corretto! La risposta corretta √®: ${corretta}`;
      
      const checkBtn = document.querySelector('.check-btn');
      if(checkBtn) checkBtn.disabled = true;

      card.innerHTML += `<div style="margin-top: 15px; padding: 10px; border-radius: 5px; background-color: ${isCorretta ? '#28a74533' : '#dc354533'};">
                            ${testoFeedback}
                         </div>`;
      setTimeout(() => { card.style.border = ''; }, 2000);
    }
    
    function salvaEsercizioAlternativo(isCorretta, corretta, rispostaData) {
        if (statoRisposta[domandeCorrenti] !== null) return; 

        statoRisposta[domandeCorrenti] = { 
            risposta: rispostaData, 
            corretta: corretta, 
            isCorretta 
        };

        if (isCorretta) {
            risposteCorrette++;
        }

        mostraFeedbackAlternativo(isCorretta, corretta);
        document.getElementById('next-btn').disabled = false;
        updateStats();
    }
    
    // --- FUNZIONI DI NAVIGAZIONE E FINE QUIZ ---

    function cambiaDomanda(delta) {
      if (domandeCorrenti + delta >= domandeTotali) {
        mostraRisultati();
        return;
      }
      if (domandeCorrenti + delta < 0) return;

      domandeCorrenti += delta;
      
      if (isQuizAlternativo) {
        caricaEsercizio();
      } else {
        caricaDomanda();
      }
    }

    function mostraRisultati() {
      document.getElementById('card-container').style.display = 'none';
      document.getElementById('controls-container').style.display = 'none';
      document.getElementById('stats-container').style.display = 'none';
      document.getElementById('progress-container').style.display = 'none';

      const recap = document.getElementById('recap');
      recap.innerHTML = `
        <div class="card" style="text-align: center;">
          <h2>Fine del Quiz!</h2>
          <p style="font-size: 1.5em; margin: 20px 0;">Hai risposto correttamente a <strong>${risposteCorrette}</strong> domande su <strong>${domandeTotali}</strong>.</p>
          <div style="margin-top: 30px;">
              <button onclick="tornaAiQuiz()" style="background-color: #6c757d;">Ricomincia/Scegli un altro Modulo</button>
          </div>
        </div>
      `;
    }

    function tornaAiQuiz(){
      document.getElementById('titolo-quiz').style.display='none';
      document.getElementById('stats-container').style.display='none';
      document.getElementById('card-container').style.display='none';
      document.getElementById('controls-container').style.display='none';
      document.getElementById('docente-container').style.display='none';
      document.getElementById('progress-container').style.display='none';
      document.getElementById('recap').innerHTML='';
      document.getElementById('quiz-buttons').style.display='block';
    }

    function tornaAllaModalita(){
      document.getElementById('quiz-buttons').style.display='none';
      document.getElementById('start-container').style.display='block';
    }
    
    function mostraQuizDocente() {
      // Logic for teacher view (can be updated later)
    }


    // --- INIZIALIZZAZIONE ---

    document.getElementById('start-quiz-btn').addEventListener('click', () => {
      document.getElementById('start-container').style.display = 'none';
      document.getElementById('quiz-buttons').style.display = 'block';
      document.getElementById('quiz-title').innerText = 'Seleziona il Modulo di Alfabetizzazione';
    });
</script>
</body>
</html>
